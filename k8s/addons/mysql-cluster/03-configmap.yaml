apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-cluster
  namespace: mysql-cluster
  labels:
    app: mysql-cluster
data:
  master.cnf: |
    # master node, only one node, the sequence is 0.
    [mysqld]
    binlog_format=MiXED
    innodb_flush_log_at_trx_commit=1
    sync_binlog=1
  slave.cnf: |
    # slave node(s), one or multi nodes, the sequence is beginning from 1 to more.
    [mysqld]
    binlog_format=MiXED
    innodb_flush_log_at_trx_commit=1
    relay-log=${HOSTNAME}-relay-bin
  10-master-root.sql: |
    create user 'root'@'%' identified with mysql_native_password by '${MYSQL_ROOT_PASSWORD}';
    grant all privileges on *.* to 'root'@'%' with grant option;
    GRANT PROXY ON ''@'' TO 'root'@'%' WITH GRANT OPTION ;
    flush privileges;
  10-slave-export-master.sh: |
    if [ ! -f /var/lib/mysql-cluster/master.dump ]; then
      mysqldump -h mysql-cluster-master.${MY_POD_NAMESPACE} -uroot -p${MYSQL_ROOT_PASSWORD} --all-databases --master-data=1 >/var/lib/mysql-cluster/master.dump
    fi
  20-slave.sql: |
    source /var/lib/mysql-cluster/master.dump;
    CHANGE MASTER TO
      MASTER_HOST='mysql-cluster-master.${MY_POD_NAMESPACE}',
      MASTER_USER='root',
      MASTER_PASSWORD='${MYSQL_ROOT_PASSWORD}',
      MASTER_CONNECT_RETRY=10;
    START SLAVE;
    SHOW SLAVE STATUS \G
  30-slave-readonly.sh: |
    sed -i "/^\[mysqld\]$/asuper-read-only" /etc/my.cnf.d/slave.cnf
  99-init-end.sh: |
    [ -f /var/lib/mysql-cluster/${HOSTNAME} ] || touch /var/lib/mysql-cluster/${HOSTNAME}
